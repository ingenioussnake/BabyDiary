<div class="hd">
    <a class="icon icon_back" href="./index.php"></a>
    <h1 class="page_title">宝宝好能睡</h1>
    <a class="icon icon_new" href="./action.html?type=dining"></a>
</div>
<div class="sleep">
    <div class="unit_header">
        <select class="unit_control">
          <option value="day">日</option>
          <option value="week">周</option>
          <option value="month">月</option>
        </select>
    </div>
    <div class="charts">
        <div class="chart_container">
            <canvas id="sleep_chart" width="200", height="400"></canvas>
        </div>
    </div>
</div>
<script type="text/javascript">
(function(){
    $(".unit_control").Segment();
    var chart = createChart("sleep_chart");
    $(".ui-segment span.option").on("click", function(a){
        getData($(this).attr("value"));
    });
    getData("day");
    function getData(unit) {
        $.get("./db/statistic.php?type=sleep&unit="+unit, function(data){
            console.log(data);
            var labels = [], sleep_data = [], label;
            $.each(data, function(index, value){
                label = value[unit];
                if (unit === "day") {
                    label = new Date(label);
                    label = (label.getMonth() + 1) + "-" + label.getDate();
                }
                labels[index] = label;
                sleep_data[index] = (parseInt(value.duration) || 0) / 60;
            });
            chart.data.labels = labels;
            chart.data.datasets[0].label = unit;
            chart.data.datasets[0].data = sleep_data;
            chart.update();
        }, "json");
    }

    function createChart (id) {
        var ctx = document.getElementById(id).getContext("2d");
        var data = {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: "#F7464A"
            }]
        };
        return new Chart(ctx, {
            type: 'horizontalBar',
            data: data,
            options: {
                maintainAspectRatio: false,
                responsive: true,
                hoverAnimationDuration: 400,
                stacked: false,
                legend: {
                    display: false
                },
                tooltips: {
                    callbacks: {
                        title: function (items, data) {
                            var unit = data.datasets[0].label;
                            var yLabel = items[0].yLabel;
                            if (unit === "day") {
                                yLabel = yLabel.split("-");
                                return yLabel[0] + "月" + yLabel[1] + "日";
                            } else if (unit === "week") {
                                return "第" + yLabel + "周";
                            } else {
                                return yLabel + "月";
                            }
                        },
                        label: function (item, data) {
                            var xLabel = item.xLabel;
                            return Math.floor(xLabel) + "小时" + (parseInt(xLabel * 60) % 60) + "分钟";
                        }
                    }
                },
                scales: {
                    xAxes: [{
                        type: "linear",
                        display: true,
                        ticks: {
                            display: true
                        },
                        stacked: false,
                        scaleLabel: {
                            display: true,
                            labelString: "睡眠时间(小时)"
                        }
                    }],
                    yAxes: [{
                        type: "category",
                        stacked: false
                    }]
                }
            }
        });
    }
})()
</script>
