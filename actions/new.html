<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>有事情喽</title>
    <link rel="stylesheet" href="../style/weui.min.css"/>
    <link rel="stylesheet" href="../style/common.css"/>
    <style type="text/css">
        .footer:before {
            border: 0;
        }
        .footer {
            padding-top: 0;
        }
        .footer a.weui_btn {
            width: 40%;
            margin-top: auto;
            margin-bottom: auto;
        }
        .weui_uploader_file {
            position: relative;
        }
        .weui_uploader_file a.delete {
            width: 32px;
            height: 32px;
            background-image: url("../images/icons/icon_delete.png");
            background-size: contain;
            position: absolute;
            bottom: 0px;
            right: 0px;
        }
    </style>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.min.js"></script>
    <script src="../js/action.js"></script>
    <script type="text/javascript">
        $(function(){
            var TITLE = {
                dining: "宝宝吃饭咯",
                sleep: "宝宝睡觉咯",
                shit: "宝宝拉臭咯",
                height: "宝宝长高咯",
                weight: "宝宝长肉咯",
                memo: "宝宝爱你咯"
            }
            var action = getUrlParam("type") || "dining";
            var fileList = [];
            $(".bd").load("./" + action + "_fragment.html", function(respond){
                if (!respond) return;
                var curr = new Date();
                $("#date").val(getDate(curr));
                if (action === "shit" || action === "height" || action === "weight" || action === "memo") {
                    $("#time").val(getTime(curr));
                } else if (action === "dining" || action === "sleep") {
                    $("#start").val(getTime(curr));
                }
                if (action === "memo") {
                    var $imgContainer = $(".weui_uploader_files"),
                        oFileReader, $img;
                    $("#pics").on("change", function(e){
                        for (var i = 0; i < this.files.length; i++) {
                            oFileReader = new FileReader();
                            oFileReader.onload = function (e) {
                                $img = $("<li><a class='delete' href='javascript:;'></a></li>");
                                $img.addClass("weui_uploader_file");
                                $img.css("background-image", "url("+e.target.result+")");
                                $imgContainer.append($img);
                            };
                            oFileReader.readAsDataURL(this.files[i]);
                            fileList.push(this.files[i]);
                        }
                    });
                    $(".weui_uploader_files").on("click", "a.delete", function(e){
                        $img = $(e.target).parent();
                        var index = $img.index();
                        fileList.splice(index, 1);
                        $img.remove();
                    })
                }
            });

            $("#submit").on("click", function(){
                $.post("./action.php", {
                    type: action,
                    data: gatherData(action)
                }, function(respond){
                    console.log(respond);
                    !!respond && showToast();
                });
            });

            $(".page_title").html(TITLE[action]);
        });
    </script>
</head>

<body>
    <div class="container">
        <div class="page slideIn cell">
            <div class="hd">
                <h1 class="page_title"></h1>
            </div>
            <div class="bd">
            </div>
            <div class="weui_cell footer">
                <a id="submit" class="weui_btn weui_btn_primary" href="javascript:;">完成</a>
                <a id="submit" class="weui_btn weui_btn_primary" href="../index.php">返回</a>
            </div>
        </div>
        <div id="toast" style="display: none;">
            <div class="weui_mask_transparent"></div>
            <div class="weui_toast">
                <i class="weui_icon_toast"></i>
                <p class="weui_toast_content">已完成</p>
            </div>
        </div>
    </div>
</body>