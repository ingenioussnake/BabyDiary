<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
<title>心情记录</title>
<link rel="stylesheet" href="../style/weui.min.css"/>
<link rel="stylesheet" href="../style/common.css"/>
<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.min.js"></script>
<script type="text/javascript" charset="utf8" src="../js/jquery.bpopup.min.js"></script>
<script type="text/javascript">
$(function(){
    var ACTIVE_COUNT = 15;
    var MEMO_ITEM_TMPL = '<li class="memo_item">' +
                           '<div class="memo_item_container">' +
                               '<div class="avatarContainer">' +
                                   '<img class="avatar"></img>' +
                               '</div>' + 
                               '<div class="memo_item_content">' +
                                   '<div class="title"></div>' +
                                   '<div class="memo_container">'+
                                        '<div class="memo"></div>'+
                                        '<div class="image_container"></div>'+
                                   '</div>' +
                                   '<div class="footer">' +
                                        '<a class="icon edit" href="javascript:;"></a>' +
                                        '<a class="icon delete" href="javascript:;"></a>' +
                                        '<span class="date"></span>' +
                                   '</div>' + 
                               '</div>' + 
                       '</li>';
    var offset = 0, list = [], operatingItem;
    getMemos();
    
    function getMemos () {
        $.get("./memo.php", {offset: offset, size: ACTIVE_COUNT, type: "list"}, function(data){
            console.log(data);
            addMemos(data);
        }, "json");
    }
    
    function addMemos (data) {
        var item, $item, $list = $("#memo_list"), length = data.length, listLength = list.length;
        for (var i = 0; i < length; i++) {
            item = data[i];
            $item = $(MEMO_ITEM_TMPL);
            updateMemoItem(item, $item, true);
            $item.attr("idx", listLength + i);
            $list.append($item);
            list.push(item);
        }
        if (length === ACTIVE_COUNT) {
            $("a.more").show();
        } else {
            $("a.more").hide();
        }
    }

    function updateMemoItem (item, $li, updatePicture) {
        $li.attr("memo_id", item.id);
        updatePicture && $("img.avatar", $li).attr("src", "./memo.php?type=avatar&baby="+item.baby);
        $(".title", $li).text(item.title);      
        $("div.memo", $li).text(item.memo);
        updatePicture && $.get("./memo.php", {type: "pic_count", id: item.id}, function (data) {
            var length = data.length, i = 0;
            if (data instanceof Array && length > 0) {
                for (;i<length;i++) {
                    $("div.image_container", $li).append("<img class='imageContent' src='./memo.php?type=picture&id="+data[i]+"' />");
                }
            }
        }, "json");
        $("div.footer span.date", $li).text(new Date(item.date).toLocaleDateString());
    }
    
    $("#memo_list").on("click", function(e){
        var $target =$(e.target),
            idx = $target.closest("li.memo_item").attr("idx");
            operatingItem = list[idx];
        if ($target.hasClass("edit")) {
            showEditDialog(operatingItem);
        } else if ($target.hasClass("delete")) {
            showDeleteDialog();
        } else if ($target.hasClass("imageContent")) {
            e.preventDefault();
            $('#preview').bPopup({
                content:'image',
                contentContainer:'#preview',
                loadUrl: $target.attr("src")
            });
        }
    });

    $(".weui_btn.more").on("click", function(){
        offset = offset + ACTIVE_COUNT;
        getMemos();
    })

    function showEditDialog (item) {
        $("#edit_dialog .weui_dialog_bd").load("../actions/memo_fragment.html", function(respond){
            if (!respond) return;
            applyData(item);
            $("#edit_dialog").show();
        });
    }

    function showDeleteDialog () {
        $("#delete_dialog").show();
    }

    $("#edit_dialog_container").load("../actions/edit_dialog.html", initEditDialog);
    $("#delete_dialog_container").load("../actions/delete_dialog.html", initDeleteDialog);
    $("#toast_container").load("../actions/toast.html");

    function initEditDialog () {
        $("#edit_dialog").on("click", ".weui_btn_dialog.default", function(){
            $("#edit_dialog").hide();
        });

        $("#edit_dialog").on("click", ".weui_btn_dialog.primary", function(){
            var data = loadData();
            data.append("id", operatingItem.id);
            $.ajax({
                url: "../actions/memo.php?type=update&action=memo",
                type: "POST",
                data: data,
                contentType: false, // 告诉jQuery不要去处理发送的数据
                processData: false, // 告诉jQuery不要去设置Content-Type请求头
                success: function(respond){
                    console.log(respond);
                    if (!!respond) {
                        $("#edit_dialog").hide();
                        updateItem(data);
                        showToast();
                    }
                }
            });
        });
    }

    function initDeleteDialog () {
        $("#delete_dialog").on("click", ".weui_btn_dialog.default", function(){
            $("#delete_dialog").hide();
        });

        $("#delete_dialog").on("click", ".weui_btn_dialog.primary", function(){
            $.post("../actions/memo.php?type=remove&action=memo", {id: operatingItem.id}, function(respond){
                console.log(respond);
                if (!!respond) {
                    $("#delete_dialog").hide();
                    removeItem(operatingItem);
                    showToast();
                }
            });
        });
    }

    function updateItem (item) {
        var $li = $("li.memo_item[idx="+ list.indexOf(operatingItem) +"]", "#memo_list");
        var data = {
            baby: item.get("baby"),
            date: item.get("date"),
            id: item.get("id"),
            memo: item.get("memo"),
            title: item.get("title"),
            time: item.get("time"),
        };
        updateMemoItem(data, $li);
    }

    function removeItem (item) {
        $("li.memo_item[idx="+ list.indexOf(item) +"]", "#memo_list").remove();
    }
})
</script>
<style type="text/css">
/*@import url(http://fonts.useso.com/css?family=Lato:300,400,700|Gorditas:400,700);*/
.container {
    font-family: 'Gorditas', Helvetica, 'Hiragino Sans GB', 'Microsoft Yahei', '微软雅黑', Arial, sans-serif;
}
.panel .hd {
    display: flex;
    display: -webkit-flex;
    padding: 0;
    background-color: #3cc51f;
    padding-top: 5px;
    padding-bottom: 5px;
}
.panel .hd .page_title{
    flex-grow: 1;
    text-align: center;
    color: #fbf9fe;
    font-size: 2rem;
}
.panel .hd a.icon_back {
    background-image: url("../images/icons/icon_back.png");
}
.panel .hd a.icon_new {
    background-image: url("../images/icons/icon_new.png");
}
li.memo_item .footer {
    float: right;
    height: 2rem;
}
a.icon {
    width: 2rem;
    height: 2rem;
    display: inline-block;
    margin-left: 0.5rem;
    margin-right: 0.5rem;
    margin-top: auto;
    margin-bottom: auto;
    background-size: contain;
    background-repeat: no-repeat;
}
li.memo_item .footer a.edit {
    background-image: url("../images/icons/icon_edit.png");
}
li.memo_item .footer a.delete {
    background-image: url("../images/icons/icon_delete.png");
}
li.memo_item .footer span.date {
    margin-top: auto;
    margin-bottom: auto;
}
            
ul#memo_list {
    width: 100%;
    padding: 0;
    margin: 0;
    list-style-type: none;
}

ul#memo_list li.memo_item {
    border-bottom: 1px solid #EBEBEB;
}
ul#memo_list div.memo_item_container {
    display: flex;
    margin: 8px;
}
ul#memo_list div.avatarContainer {
    width: 64px;
    height: 64px;
    flex-grow: 0;
    flex-shrink: 0;
}
ul#memo_list img.avatar {
    width: 100%;
    height: 100%;
}
ul#memo_list div.memo_item_content {
    margin-left: 8px;
    flex-grow: 1;
}
ul#memo_list div.title {
    color: #606C8D;
    font-size: larger;
}
ul#memo_list div.memo_container {
    margin-top: 8px;
    margin-bottom: 8px;
    font-size: larger;
}
ul#memo_list img.imageContent {
    max-height: 120px;
    margin-right: 5px;
}

#preview {
    max-height: 90%;
    max-width: 90%;
}
</style>
</head>
<body>
    <div class="container" id="container">
        <div class="panel button">
            <div class="hd">
                <a class="icon icon_back" href="../index.php"></a>
                <h1 class="page_title">心情点滴</h1>
                <a class="icon icon_new" href="./action.html?type=memo"></a>

            </div>
            <div class="bd">
                <ul id="memo_list"></ul>
            </div>
            <div class="button_sp_area">
                <a href="javascript:;" class="weui_btn weui_btn_plain_default more">更多</a>
            </div>
        </div>
    </div>
    <div id="preview" style="display: none;"></div>
    <div id="toast_container"></div>
    <div id="edit_dialog_container"></div>
    <div id="delete_dialog_container"></div>
</body>
</html>